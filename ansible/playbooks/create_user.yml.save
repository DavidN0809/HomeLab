---
- name: Create ansibleuser
  hosts: all
  become: yes
  gather_facts: yes
  collections:
    - ansible.posix
  tasks:
    - name: Create ansibleuser
      user:
        name: ansibleuser
        shell: /bin/bash
        password: "{{ 'bulletx2' | password_hash('sha512') }}"

    - name: Generate ssh key on control node
      delegate_to: localhost
      command: ssh-keygen -t rsa -b 2048 -f ./ansibleuser_id_rsa -N ''
      args:
        creates: ./ansibleuser_id_rsa

    - name: Display ssh public key
      delegate_to: localhost
      command: cat ./ansibleuser_id_rsa.pub
      register: pubkey

    - name: Copy public key to authorized_keys
      ansible.posix.authorized_key:
        user: ansibleuser
        key: "{{ pubkey.stdout }}"

    - name: Move private key to ~/.ssh/id_rsa
      delegate_to: localhost
      command: mv ./ansibleuser_id_rsa ~/.ssh/id_rsa
      args:
        removes: ./ansibleuser_id_rsa

    - name: Set private key permissions
      delegate_to: localhost
      file:
        path: ~/.ssh/id_rsa
        mode: 0600

    - name: Add ansibleuser to sudoers
      lineinfile:
        dest: /etc/sudoers
        line: "ansibleuser ALL=(ALL:ALL) NOPASSWD:ALL"
        validate: visudo -cf %s
        insertafter: "^# %sudo"
        state: present
x
